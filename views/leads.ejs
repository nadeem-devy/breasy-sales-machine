<%- include('partials/header') %>

<div class="page-header">
  <h1>Leads</h1>
  <div class="btn-group" style="align-items:center;">
    <button class="btn btn-outline btn-sm" id="btnBulkScrape" onclick="bulkScrapeWebsites()">Scrape All Websites</button>
    <button class="btn btn-primary btn-sm" onclick="window.location='/import'">Import Leads</button>
  </div>
</div>

<!-- Stats Row -->
<div class="leads-stats-row" id="leadStats">
  <div class="leads-stat-card">
    <div class="leads-stat-value" id="statTotal">—</div>
    <div class="leads-stat-label">Total Leads</div>
  </div>
  <div class="leads-stat-card">
    <div class="leads-stat-value" id="statActive" style="color:var(--blue)">—</div>
    <div class="leads-stat-label">Active Sequences</div>
  </div>
  <div class="leads-stat-card">
    <div class="leads-stat-value" id="statQualified" style="color:var(--green)">—</div>
    <div class="leads-stat-label">Qualified</div>
  </div>
  <div class="leads-stat-card">
    <div class="leads-stat-value" id="statReplied" style="color:var(--yellow)">—</div>
    <div class="leads-stat-label">Replied</div>
  </div>
</div>
<div class="leads-stats-row leads-stats-secondary">
  <div class="leads-stat-card-sm">
    <span class="leads-stat-sm-icon">&#9993;</span>
    <span class="leads-stat-sm-value" id="statSms">0</span>
    <span class="leads-stat-sm-label">SMS Sent</span>
  </div>
  <div class="leads-stat-card-sm">
    <span class="leads-stat-sm-icon">&#9993;</span>
    <span class="leads-stat-sm-value" id="statEmails">0</span>
    <span class="leads-stat-sm-label">Emails Sent</span>
  </div>
  <div class="leads-stat-card-sm">
    <span class="leads-stat-sm-icon">&#9742;</span>
    <span class="leads-stat-sm-value" id="statCalls">0</span>
    <span class="leads-stat-sm-label">Calls Made</span>
  </div>
  <div class="leads-stat-card-sm">
    <span class="leads-stat-sm-icon">&#9733;</span>
    <span class="leads-stat-sm-value" id="statAvgScore">0</span>
    <span class="leads-stat-sm-label">Avg Score</span>
  </div>
  <div class="leads-stat-card-sm">
    <span class="leads-stat-sm-icon" style="color:var(--orange)">&#9632;</span>
    <span class="leads-stat-sm-value" id="statHot">0</span>
    <span class="leads-stat-sm-label">Hot</span>
  </div>
  <div class="leads-stat-card-sm">
    <span class="leads-stat-sm-icon" style="color:var(--yellow)">&#9632;</span>
    <span class="leads-stat-sm-value" id="statWarm">0</span>
    <span class="leads-stat-sm-label">Warm</span>
  </div>
</div>

<!-- Tabs -->
<div class="tabs" id="leadTabs">
  <div class="tab active" data-filter="">All</div>
  <div class="tab" data-filter="new">New</div>
  <div class="tab" data-filter="lead">Lead</div>
  <div class="tab" data-filter="discovery">Discovery</div>
  <div class="tab" data-filter="qualifying">Qualifying</div>
  <div class="tab" data-filter="ready_for_work">Ready for Work</div>
  <div class="tab" data-filter="bad_data">Bad Data</div>
  <div class="tab" data-filter="do_not_call">DNC</div>
  <div class="tab" data-filter="not_a_fit">Not a Fit</div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
  <input type="text" id="searchInput" placeholder="Search name, company, email, phone..." style="min-width:280px;" onkeyup="debounceSearch()">
  <select id="campaignFilter" onchange="loadLeads()">
    <option value="">All Campaigns</option>
  </select>
  <select id="tierFilter" onchange="loadLeads()">
    <option value="">All Scores</option>
    <option value="qualified">Qualified (61+)</option>
    <option value="hot">Hot (41-60)</option>
    <option value="warm">Warm (21-40)</option>
    <option value="cold">Cold (0-20)</option>
    <option value="dead">Dead (&lt;0)</option>
  </select>
  <select id="reviewFilter" onchange="loadLeads()">
    <option value="">All Reviews</option>
    <option value="5">5 or less</option>
    <option value="10">10 or less</option>
    <option value="25">25 or less</option>
    <option value="50">50 or less</option>
    <option value="100">100 or less</option>
    <option value="0">0 reviews</option>
  </select>
  <span id="leadCount" style="color:var(--text-dim);font-size:13px;"></span>
</div>

<!-- Lead List -->
<div class="lead-list" id="leadList">
  <div class="inbox-empty" style="padding:40px;">Loading leads...</div>
</div>

<!-- Pagination -->
<div style="display:flex;justify-content:center;gap:12px;margin-top:16px;">
  <button class="btn btn-outline btn-sm" id="prevBtn" onclick="changePage(-1)" disabled>Previous</button>
  <span id="pageInfo" style="color:var(--text-dim);font-size:13px;line-height:30px;">Page 1</span>
  <button class="btn btn-outline btn-sm" id="nextBtn" onclick="changePage(1)">Next</button>
</div>

<!-- HubSpot-Style Right Sidebar -->
<div id="leadSidebar" class="lead-sidebar">
  <div class="lead-sidebar-overlay" onclick="closeSidebar()"></div>
  <div class="lead-sidebar-panel">
    <div class="lead-sidebar-header">
      <div>
        <h2 id="sidebarLeadName" style="margin:0;font-size:18px;color:var(--text);">Loading...</h2>
        <div id="sidebarLeadCompany" style="font-size:13px;color:var(--text-dim);margin-top:2px;"></div>
      </div>
      <button onclick="closeSidebar()" style="background:none;border:none;font-size:24px;color:var(--text-dim);cursor:pointer;padding:0;line-height:1;">&times;</button>
    </div>

    <div class="lead-sidebar-tabs">
      <div class="sidebar-tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div>
      <div class="sidebar-tab" data-tab="activity" onclick="switchTab('activity')">Activity</div>
      <div class="sidebar-tab" data-tab="notes" onclick="switchTab('notes')">Notes</div>
    </div>

    <div class="lead-sidebar-content" id="sidebarContent">
      <div class="sidebar-tab-content active" id="tab-overview">
        <div id="sidebarOverview">Loading...</div>
      </div>
      <div class="sidebar-tab-content" id="tab-activity">
        <div id="sidebarActivity">Loading...</div>
      </div>
      <div class="sidebar-tab-content" id="tab-notes">
        <div id="sidebarNotes">Loading...</div>
      </div>
    </div>

    <div class="lead-sidebar-footer">
      <button class="btn btn-primary" onclick="openFullLead()" style="width:100%;">View Full Lead</button>
    </div>
  </div>
</div>

<style>
  .leads-stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .leads-stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
    text-align: center;
  }
  .leads-stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }
  .leads-stat-label {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .leads-stats-secondary {
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    margin-top: -12px;
    margin-bottom: 16px;
  }
  .leads-stat-card-sm {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .leads-stat-sm-icon {
    font-size: 14px;
    opacity: 0.6;
  }
  .leads-stat-sm-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    font-variant-numeric: tabular-nums;
  }
  .leads-stat-sm-label {
    font-size: 11px;
    color: var(--text-dim);
  }

  .lead-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .lead-card {
    display: flex;
    align-items: center;
    gap: 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
  }
  .lead-card:hover {
    border-color: var(--blue);
    background: rgba(59,130,246,0.04);
  }

  .lead-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    flex-shrink: 0;
    background: rgba(59,130,246,0.15);
    color: #60a5fa;
  }
  .lead-avatar.tier-qualified { background: rgba(16,185,129,0.15); color: var(--green); }
  .lead-avatar.tier-hot { background: rgba(249,115,22,0.15); color: var(--orange); }
  .lead-avatar.tier-warm { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .lead-avatar.tier-cold { background: rgba(148,163,184,0.12); color: #94a3b8; }
  .lead-avatar.tier-dead { background: rgba(239,68,68,0.12); color: var(--red); }

  .lead-info {
    flex: 1;
    min-width: 0;
  }
  .lead-info-top {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
  }
  .lead-name {
    font-weight: 600;
    color: var(--text);
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .lead-company {
    color: var(--text-dim);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .lead-detail-row {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .lead-service {
    max-width: 160px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .lead-phone {
    font-variant-numeric: tabular-nums;
  }
  .lead-location {
    white-space: nowrap;
  }

  .lead-score-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    flex-shrink: 0;
    min-width: 52px;
  }
  .lead-score-circle {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    border: 2px solid;
  }
  .lead-score-circle.tier-qualified { border-color: var(--green); color: var(--green); background: rgba(16,185,129,0.08); }
  .lead-score-circle.tier-hot { border-color: var(--orange); color: var(--orange); background: rgba(249,115,22,0.08); }
  .lead-score-circle.tier-warm { border-color: var(--yellow); color: var(--yellow); background: rgba(245,158,11,0.08); }
  .lead-score-circle.tier-cold { border-color: #64748b; color: #94a3b8; background: rgba(148,163,184,0.06); }
  .lead-score-circle.tier-dead { border-color: var(--red); color: var(--red); background: rgba(239,68,68,0.06); }
  .lead-tier-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    font-weight: 600;
  }
  .lead-tier-label.tier-qualified { color: var(--green); }
  .lead-tier-label.tier-hot { color: var(--orange); }
  .lead-tier-label.tier-warm { color: var(--yellow); }
  .lead-tier-label.tier-cold { color: #94a3b8; }
  .lead-tier-label.tier-dead { color: var(--red); }

  .lead-tags-col {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    flex-shrink: 0;
    min-width: 110px;
  }
  .lead-status-tag {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .status-new { background: #1e1b4b; color: #818cf8; }
  .status-lead { background: #172554; color: #60a5fa; }
  .status-discovery { background: #14532d; color: #4ade80; }
  .status-qualifying { background: #3b0764; color: #c084fc; }
  .status-ready_for_work { background: #052e16; color: var(--green); }
  .status-bad_data { background: rgba(239,68,68,0.12); color: var(--red); }
  .status-do_not_call { background: rgba(239,68,68,0.15); color: #f87171; }
  .status-not_a_fit { background: rgba(148,163,184,0.12); color: #94a3b8; }

  .lead-seq-tag {
    font-size: 11px;
    color: var(--text-dim);
  }
  .lead-seq-tag.seq-active { color: var(--blue); }
  .lead-seq-tag.seq-paused { color: var(--yellow); }
  .lead-seq-tag.seq-completed { color: var(--green); }

  .lead-activity-col {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
    min-width: 110px;
  }
  .lead-activity-item {
    display: flex;
    align-items: center;
    gap: 3px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .lead-activity-icon {
    font-size: 13px;
    opacity: 0.7;
  }
  .lead-activity-count {
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }
  .lead-activity-item.has-reply {
    color: var(--green);
  }
  .lead-activity-item.has-reply .lead-activity-icon {
    opacity: 1;
  }

  .lead-meta-col {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
    flex-shrink: 0;
    min-width: 70px;
  }
  .lead-last-contact {
    font-size: 12px;
    color: var(--text-dim);
  }
  .lead-created {
    font-size: 11px;
    color: var(--text-dim);
    opacity: 0.6;
  }

  @media (max-width: 1024px) {
    .leads-stats-row { grid-template-columns: repeat(2, 1fr); }
    .leads-stats-secondary { grid-template-columns: repeat(3, 1fr); }
    .lead-activity-col { display: none; }
    .lead-detail-row .lead-phone { display: none; }
    .lead-detail-row .lead-location { display: none; }
  }
  @media (max-width: 768px) {
    .leads-stats-secondary { grid-template-columns: repeat(2, 1fr); }
    .lead-card { flex-wrap: wrap; padding: 10px 12px; gap: 10px; }
    .lead-score-col { order: -1; }
    .lead-tags-col { flex-direction: row; width: 100%; }
    .lead-meta-col { align-items: flex-start; }
  }

  /* HubSpot-Style Sidebar */
  .lead-sidebar {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .lead-sidebar.open {
    pointer-events: auto;
    opacity: 1;
  }
  .lead-sidebar-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    cursor: pointer;
  }
  .lead-sidebar-panel {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 480px;
    max-width: 90vw;
    background: var(--bg-card);
    border-left: 1px solid var(--border);
    box-shadow: -4px 0 24px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }
  .lead-sidebar.open .lead-sidebar-panel {
    transform: translateX(0);
  }
  .lead-sidebar-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
  }
  .lead-sidebar-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }
  .sidebar-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .sidebar-tab:hover {
    color: var(--text);
    background: var(--bg-hover);
  }
  .sidebar-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .lead-sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
  }
  .sidebar-tab-content {
    display: none;
  }
  .sidebar-tab-content.active {
    display: block;
  }
  .lead-sidebar-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
  }
  .sidebar-info-table {
    width: 100%;
    margin-bottom: 16px;
  }
  .sidebar-info-table td {
    padding: 8px 0;
    font-size: 13px;
    vertical-align: top;
  }
  .sidebar-info-table td:first-child {
    color: var(--text-dim);
    width: 100px;
  }
  .sidebar-info-table td:last-child {
    font-weight: 500;
    color: var(--text);
  }
  .sidebar-stat-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 16px 0;
  }
  .sidebar-stat-box {
    text-align: center;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .sidebar-stat-val {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }
  .sidebar-stat-lbl {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
    text-transform: uppercase;
  }
  .sidebar-activity-item {
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-activity-item:last-child {
    border-bottom: none;
  }
  .sidebar-activity-time {
    font-size: 11px;
    color: var(--text-dim);
  }
  .sidebar-activity-type {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin: 4px 0;
  }
  .sidebar-activity-content {
    font-size: 12px;
    color: var(--text-dim);
  }
</style>

<script>
let currentPage = 1;
let currentStatus = '';
let currentTier = '';
let searchTimeout;

// Tab clicks
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentStatus = tab.dataset.filter || '';
    currentTier = tab.dataset.tier || '';
    document.getElementById('tierFilter').value = currentTier;
    currentPage = 1;
    loadLeads();
  });
});

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { currentPage = 1; loadLeads(); }, 300);
}

function changePage(delta) {
  currentPage += delta;
  if (currentPage < 1) currentPage = 1;
  loadLeads();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

function parseDate(str) {
  if (!str) return null;
  // Handle SQLite format "2026-02-06 15:36:24" (no T, no Z)
  if (str.includes(' ') && !str.includes('T')) {
    return new Date(str.replace(' ', 'T') + 'Z');
  }
  // Handle ISO format — add Z only if no timezone info
  if (!str.endsWith('Z') && !str.includes('+')) {
    return new Date(str + 'Z');
  }
  return new Date(str);
}

function formatDate(date) {
  if (!date || isNaN(date.getTime())) return '—';
  return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
}

function timeAgo(date) {
  if (!date || isNaN(date.getTime())) return '—';
  const secs = Math.floor((new Date() - date) / 1000);
  if (secs < 0) return '—';
  if (secs < 60) return 'Just now';
  if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
  if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
  if (secs < 604800) return Math.floor(secs / 86400) + 'd ago';
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

async function loadLeads() {
  const search = document.getElementById('searchInput').value;
  const campaign = document.getElementById('campaignFilter').value;
  const tier = document.getElementById('tierFilter').value || currentTier;
  const maxReviews = document.getElementById('reviewFilter').value;

  let url = `/api/leads?page=${currentPage}&limit=50`;
  if (currentStatus) url += `&status=${currentStatus}`;
  if (tier) url += `&score_tier=${tier}`;
  if (campaign) url += `&campaign_id=${campaign}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (maxReviews) url += `&max_review_count=${maxReviews}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    const container = document.getElementById('leadList');

    document.getElementById('leadCount').textContent = `${data.total} leads`;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${Math.ceil(data.total / 50) || 1}`;
    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage * 50 >= data.total;

    // Stats from full aggregate (not just current page)
    const s = data.stats || {};
    document.getElementById('statTotal').textContent = data.total || 0;
    document.getElementById('statActive').textContent = s.active_sequences || 0;
    document.getElementById('statQualified').textContent = s.qualified || 0;
    document.getElementById('statReplied').textContent = s.replied || 0;
    document.getElementById('statSms').textContent = s.total_sms || 0;
    document.getElementById('statEmails').textContent = s.total_emails || 0;
    document.getElementById('statCalls').textContent = s.total_calls || 0;
    document.getElementById('statAvgScore').textContent = s.avg_score || 0;
    document.getElementById('statHot').textContent = s.hot || 0;
    document.getElementById('statWarm').textContent = s.warm || 0;

    const leads = data.leads || [];
    if (!leads.length) {
      container.innerHTML = '<div class="inbox-empty" style="padding:40px;">No leads found</div>';
      return;
    }

    container.innerHTML = leads.map(l => {
      const initial = (l.first_name || '?')[0].toUpperCase();
      const tierCls = 'tier-' + (l.score_tier || 'cold');
      const contactDate = parseDate(l.last_contacted_at || l.created_at);
      const lastContact = contactDate ? formatDate(contactDate) : '—';
      const seqLabel = l.sequence_status === 'active'
        ? `Step ${l.current_step}/7`
        : (l.sequence_status || 'pending').replace(/_/g, ' ');
      const seqCls = l.sequence_status === 'active' ? 'seq-active'
        : l.sequence_status === 'paused' ? 'seq-paused'
        : l.sequence_status === 'completed' ? 'seq-completed' : '';
      const statusCls = 'status-' + (l.status || 'new');
      const hasReply = l.replied ? ' has-reply' : '';
      const location = [l.city, l.state].filter(Boolean).join(', ');

      return `<div class="lead-card" onclick="openLeadSidebar(${l.id}); event.stopPropagation();">
        <div class="lead-avatar ${tierCls}">${initial}</div>
        <div class="lead-info">
          <div class="lead-info-top">
            <span class="lead-name">${escapeHtml(l.first_name + ' ' + (l.last_name || ''))}</span>
            <span class="lead-company">${escapeHtml(l.company_name || '')}</span>
          </div>
          <div class="lead-detail-row">
            ${l.service_type ? `<span class="lead-service">${escapeHtml(l.service_type)}</span>` : ''}
            ${l.phone ? `<span class="lead-phone">${escapeHtml(l.phone)}</span>` : ''}
            ${location ? `<span class="lead-location">${escapeHtml(location)}</span>` : ''}
          </div>
        </div>
        <div class="lead-score-col">
          <div class="lead-score-circle ${tierCls}">${l.score}</div>
          <div class="lead-tier-label ${tierCls}">${l.score_tier || 'cold'}</div>
          ${l.qualification_grade ? `<div style="font-size:11px;font-weight:700;margin-top:2px;color:${{A:'var(--green)',B:'var(--accent)',C:'var(--yellow)',D:'var(--orange)',F:'var(--red)'}[l.qualification_grade] || 'var(--text-dim)'};">Grade ${l.qualification_grade}</div>` : ''}
        </div>
        <div class="lead-tags-col">
          <span class="lead-status-tag ${statusCls}">${(l.status || 'new').replace(/_/g, ' ')}</span>
          <span class="lead-seq-tag ${seqCls}">${seqLabel}</span>
        </div>
        <div class="lead-activity-col">
          <div class="lead-activity-item" title="SMS sent">
            <span class="lead-activity-icon">&#9993;</span>
            <span class="lead-activity-count">${l.total_sms_sent || 0}</span>
          </div>
          <div class="lead-activity-item" title="Emails sent">
            <span class="lead-activity-icon">&#9993;</span>
            <span class="lead-activity-count">${l.total_emails_sent || 0}</span>
          </div>
          <div class="lead-activity-item${hasReply}" title="Calls made${l.replied ? ' (replied)' : ''}">
            <span class="lead-activity-icon">&#9742;</span>
            <span class="lead-activity-count">${l.total_calls_made || 0}</span>
          </div>
        </div>
        <div class="lead-meta-col">
          <span class="lead-last-contact">${lastContact}</span>
        </div>
      </div>`;
    }).join('');
  } catch (e) { console.error('Load leads error:', e); }
}

// Load campaigns for filter
fetch('/api/dashboard/campaigns').then(r => r.json()).then(campaigns => {
  const sel = document.getElementById('campaignFilter');
  campaigns.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
});

// ========== HubSpot-Style Sidebar ==========

let currentLeadId = null;

function openLeadSidebar(leadId) {
  currentLeadId = leadId;
  document.getElementById('leadSidebar').classList.add('open');
  loadSidebarData(leadId);
}

function closeSidebar() {
  document.getElementById('leadSidebar').classList.remove('open');
  currentLeadId = null;
}

function switchTab(tab) {
  // Update tab active states
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.sidebar-tab[data-tab="${tab}"]`).classList.add('active');

  // Update content active states
  document.querySelectorAll('.sidebar-tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
}

function openFullLead() {
  if (currentLeadId) {
    window.location = `/lead/${currentLeadId}`;
  }
}

async function loadSidebarData(leadId) {
  try {
    const res = await fetch(`/api/leads/${leadId}`);
    const data = await res.json();
    const l = data.lead;

    // Header
    const fullName = [l.first_name, l.last_name].filter(Boolean).join(' ') || 'Unknown';
    document.getElementById('sidebarLeadName').textContent = fullName;
    document.getElementById('sidebarLeadCompany').textContent = l.company_name || '';

    // Overview tab
    const gradeColors = { A: 'var(--green)', B: 'var(--accent)', C: 'var(--yellow)', D: 'var(--orange)', F: 'var(--red)' };
    const gradeColor = gradeColors[l.qualification_grade] || 'var(--text-dim)';

    document.getElementById('sidebarOverview').innerHTML = `
      <div class="sidebar-stat-row">
        <div class="sidebar-stat-box">
          <div class="sidebar-stat-val" style="color:${gradeColor};">${l.qualification_grade || '—'}</div>
          <div class="sidebar-stat-lbl">Grade</div>
        </div>
        <div class="sidebar-stat-box">
          <div class="sidebar-stat-val" style="color:var(--accent);">${l.score}</div>
          <div class="sidebar-stat-lbl">Score</div>
        </div>
        <div class="sidebar-stat-box">
          <div class="sidebar-stat-val">${l.score_tier || 'cold'}</div>
          <div class="sidebar-stat-lbl">Tier</div>
        </div>
      </div>

      <table class="sidebar-info-table">
        <tr><td>Email</td><td>${l.email ? '<a href="mailto:' + escapeHtml(l.email) + '" style="color:var(--accent);">' + escapeHtml(l.email) + '</a>' : '—'}</td></tr>
        <tr><td>Phone</td><td>${l.phone ? '<a href="tel:' + escapeHtml(l.phone) + '" style="color:var(--accent);">' + escapeHtml(l.phone) + '</a>' : '—'}</td></tr>
        <tr><td>Company</td><td>${escapeHtml(l.company_name || '—')}</td></tr>
        <tr><td>Title</td><td>${escapeHtml(l.job_title || '—')}</td></tr>
        <tr><td>Industry</td><td>${escapeHtml(l.industry || '—')}</td></tr>
        <tr><td>Service</td><td>${escapeHtml(l.service_type || '—')}</td></tr>
        <tr><td>Location</td><td>${escapeHtml([l.city, l.state].filter(Boolean).join(', ') || '—')}</td></tr>
        <tr><td>Status</td><td><span class="badge badge-${l.status}">${(l.status||'new').replace(/_/g,' ')}</span></td></tr>
        <tr><td>Sequence</td><td>Step ${l.current_step}/7 — ${l.sequence_status}</td></tr>
      </table>

      <div class="sidebar-stat-row">
        <div class="sidebar-stat-box">
          <div class="sidebar-stat-val">${l.total_sms_sent || 0}</div>
          <div class="sidebar-stat-lbl">SMS Sent</div>
        </div>
        <div class="sidebar-stat-box">
          <div class="sidebar-stat-val">${l.total_emails_sent || 0}</div>
          <div class="sidebar-stat-lbl">Emails</div>
        </div>
        <div class="sidebar-stat-box">
          <div class="sidebar-stat-val">${l.total_calls_made || 0}</div>
          <div class="sidebar-stat-lbl">Calls</div>
        </div>
      </div>
    `;

    // Activity tab
    const activities = data.activities || [];
    if (!activities.length) {
      document.getElementById('sidebarActivity').innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:40px 0;">No activity yet</div>';
    } else {
      document.getElementById('sidebarActivity').innerHTML = activities.slice(0, 10).map(a => {
        const time = new Date(a.created_at + 'Z').toLocaleString();
        const typeLabel = (a.type || '').replace(/_/g, ' ');
        return `<div class="sidebar-activity-item">
          <div class="sidebar-activity-time">${time}</div>
          <div class="sidebar-activity-type">${escapeHtml(typeLabel)}</div>
          <div class="sidebar-activity-content">${escapeHtml((a.content || '').substring(0, 200))}</div>
        </div>`;
      }).join('');
    }

    // Notes tab
    const noteActivities = activities.filter(a => a.type === 'note_added');
    if (!noteActivities.length) {
      document.getElementById('sidebarNotes').innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:40px 0;">No notes yet</div>';
    } else {
      document.getElementById('sidebarNotes').innerHTML = noteActivities.map(a => {
        const time = new Date(a.created_at + 'Z').toLocaleString();
        return `<div class="sidebar-activity-item">
          <div class="sidebar-activity-time">${time}</div>
          <div class="sidebar-activity-content" style="margin-top:6px;">${escapeHtml(a.content || '')}</div>
        </div>`;
      }).join('');
    }

  } catch (e) {
    console.error('Load sidebar error:', e);
  }
}

// Close sidebar on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('leadSidebar').classList.contains('open')) {
    closeSidebar();
  }
});

// ========== Bulk Website Scraper ==========

function showBulkOverlay(total) {
  var existing = document.getElementById('bulkScrapeOverlay');
  if (existing) existing.remove();

  var overlay = document.createElement('div');
  overlay.id = 'bulkScrapeOverlay';
  overlay.innerHTML = `
    <div style="position:fixed;inset:0;background:var(--overlay-bg,rgba(0,0,0,0.7));z-index:1000;display:flex;align-items:center;justify-content:center;">
      <div style="background:var(--bg-card,#1a1a2e);border:1px solid var(--border,#333);border-radius:16px;padding:32px 40px;min-width:420px;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
          <div id="bulkSpinner">
            <svg width="32" height="32" viewBox="0 0 48 48" style="animation:scrape-spin 1s linear infinite;">
              <circle cx="24" cy="24" r="20" fill="none" stroke="var(--border,#444)" stroke-width="4"/>
              <circle cx="24" cy="24" r="20" fill="none" stroke="var(--primary,#6366f1)" stroke-width="4" stroke-dasharray="80 50" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div id="bulkTitle" style="font-size:17px;font-weight:600;">Scraping Websites</div>
            <div id="bulkSubtitle" style="color:var(--text-dim,#888);font-size:13px;">0 of ${total} leads</div>
          </div>
        </div>
        <div style="background:var(--bg-main,#111);border-radius:8px;height:8px;overflow:hidden;margin-bottom:16px;">
          <div id="bulkProgressBar" style="height:100%;background:var(--primary,#6366f1);border-radius:8px;width:0%;transition:width 0.4s ease;"></div>
        </div>
        <div id="bulkStats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;">
          <div style="text-align:center;padding:8px;background:var(--bg-main,#111);border-radius:8px;">
            <div id="bulkStatOk" style="font-size:20px;font-weight:700;color:var(--green,#22c55e);">0</div>
            <div style="font-size:11px;color:var(--text-dim);">Scraped</div>
          </div>
          <div style="text-align:center;padding:8px;background:var(--bg-main,#111);border-radius:8px;">
            <div id="bulkStatUpdated" style="font-size:20px;font-weight:700;color:var(--primary,#6366f1);">0</div>
            <div style="font-size:11px;color:var(--text-dim);">Updated</div>
          </div>
          <div style="text-align:center;padding:8px;background:var(--bg-main,#111);border-radius:8px;">
            <div id="bulkStatFailed" style="font-size:20px;font-weight:700;color:var(--red,#ef4444);">0</div>
            <div style="font-size:11px;color:var(--text-dim);">Failed</div>
          </div>
        </div>
        <div id="bulkLog" style="max-height:180px;overflow-y:auto;font-size:12px;color:var(--text-dim,#888);border:1px solid var(--border,#333);border-radius:8px;padding:8px;"></div>
        <button id="bulkCloseBtn" style="display:none;margin-top:16px;width:100%;padding:10px;background:var(--primary,#6366f1);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;" onclick="document.getElementById('bulkScrapeOverlay').remove()">Done</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}

var bulkOk = 0, bulkUpdated = 0, bulkFailed = 0;

function updateBulkOverlay(d) {
  if (d.type === 'progress') {
    var pct = Math.round((d.completed / d.total) * 100);
    document.getElementById('bulkProgressBar').style.width = pct + '%';
    document.getElementById('bulkSubtitle').textContent = d.completed + ' of ' + d.total + ' leads (' + pct + '%)';

    if (d.status === 'ok') {
      bulkOk++;
      if (d.updatedFields && d.updatedFields.length > 0) bulkUpdated++;
    } else {
      bulkFailed++;
    }
    document.getElementById('bulkStatOk').textContent = bulkOk;
    document.getElementById('bulkStatUpdated').textContent = bulkUpdated;
    document.getElementById('bulkStatFailed').textContent = bulkFailed;

    // Add log entry
    var log = document.getElementById('bulkLog');
    var icon = d.status === 'ok' ? '<span style="color:var(--green);">&#10003;</span>' : '<span style="color:var(--red);">&#10007;</span>';
    var detail = d.status === 'ok' ? (d.updatedFields && d.updatedFields.length ? 'updated ' + d.updatedFields.join(', ') : 'no new data') : (d.error || 'error');
    log.innerHTML += '<div style="padding:2px 0;">' + icon + ' Lead #' + d.leadId + ' — ' + detail + '</div>';
    log.scrollTop = log.scrollHeight;
  }

  if (d.type === 'done') {
    document.getElementById('bulkTitle').textContent = 'Scrape Complete';
    document.getElementById('bulkSubtitle').textContent = d.completed + ' leads processed';
    document.getElementById('bulkProgressBar').style.width = '100%';
    document.getElementById('bulkProgressBar').style.background = 'var(--green,#22c55e)';
    document.getElementById('bulkSpinner').innerHTML = '<div style="font-size:28px;">&#10003;</div>';
    document.getElementById('bulkCloseBtn').style.display = 'block';
  }
}

async function bulkScrapeWebsites() {
  if (!confirm('Scrape websites for all leads that haven\'t been scraped yet?\nThis runs in the background with a 2s delay between each.')) return;

  var btn = document.getElementById('btnBulkScrape');
  btn.disabled = true;
  btn.textContent = 'Scraping...';
  bulkOk = 0; bulkUpdated = 0; bulkFailed = 0;

  try {
    var res = await fetch('/api/enrichment/bulk-website-scrape', { method: 'POST' });
    var data = await res.json();

    if (data.total === 0) {
      alert(data.message);
      btn.disabled = false;
      btn.textContent = 'Scrape All Websites';
      return;
    }

    showBulkOverlay(data.total);

    var evtSource = new EventSource('/api/enrichment/bulk-website-scrape/status');

    evtSource.onmessage = function(event) {
      var d = JSON.parse(event.data);
      updateBulkOverlay(d);

      if (d.type === 'done') {
        evtSource.close();
        btn.disabled = false;
        btn.textContent = 'Scrape All Websites';
        loadLeads();
      }
    };

    evtSource.onerror = function() {
      evtSource.close();
      btn.disabled = false;
      btn.textContent = 'Scrape All Websites';
    };
  } catch (e) {
    alert('Bulk scrape failed: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Scrape All Websites';
  }
}

loadLeads();
</script>
<style>@keyframes scrape-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>

<%- include('partials/footer') %>
