<%- include('partials/header') %>

<div class="page-header">
  <h1>Call Log</h1>
  <div class="btn-group">
    <select id="typeFilter" onchange="loadCallLog()" style="width:auto;">
      <option value="">All Types</option>
      <option value="ai">AI Calls</option>
      <option value="manual">Manual Calls</option>
      <option value="inbound">Inbound Calls</option>
      <option value="browser">Browser Calls</option>
    </select>
    <select id="statusFilter" onchange="loadCallLog()" style="width:auto;">
      <option value="">All Statuses</option>
      <option value="completed">Completed</option>
      <option value="no_answer">No Answer</option>
      <option value="voicemail">Voicemail</option>
      <option value="busy">Busy</option>
      <option value="failed">Failed</option>
      <option value="initiated">Initiated</option>
    </select>
    <select id="outcomeFilter" onchange="loadCallLog()" style="width:auto;">
      <option value="">All Outcomes</option>
      <option value="qualified">Qualified</option>
      <option value="callback">Callback</option>
      <option value="not_interested">Not Interested</option>
      <option value="no_answer">No Answer</option>
      <option value="voicemail">Voicemail</option>
      <option value="wrong_number">Wrong Number</option>
      <option value="busy">Busy</option>
      <option value="gatekeeper">Gatekeeper</option>
      <option value="not_qualified">Not Qualified</option>
    </select>
  </div>
</div>

<!-- Stats Row -->
<div class="call-stats-row" id="callStats">
  <div class="call-stat-card">
    <div class="call-stat-value" id="statTotal">—</div>
    <div class="call-stat-label">Total Calls</div>
  </div>
  <div class="call-stat-card">
    <div class="call-stat-value" id="statConnected" style="color:var(--green)">—</div>
    <div class="call-stat-label">Connected</div>
  </div>
  <div class="call-stat-card">
    <div class="call-stat-value" id="statAvgDuration" style="color:var(--blue)">—</div>
    <div class="call-stat-label">Avg Duration</div>
  </div>
  <div class="call-stat-card">
    <div class="call-stat-value" id="statQualified" style="color:var(--yellow)">—</div>
    <div class="call-stat-label">Qualified</div>
  </div>
</div>

<!-- Call List -->
<div class="call-list" id="callList">
  <div class="inbox-empty" style="padding:40px;">Loading call log...</div>
</div>

<div style="display:flex;justify-content:center;gap:12px;margin-top:16px;">
  <button class="btn btn-outline btn-sm" id="prevBtn" onclick="changePage(-1)" disabled>Previous</button>
  <span id="pageInfo" style="color:var(--text-dim);font-size:13px;line-height:30px;">Page 1</span>
  <button class="btn btn-outline btn-sm" id="nextBtn" onclick="changePage(1)">Next</button>
</div>

<!-- Transcript Modal -->
<div class="call-modal-overlay" id="transcriptModal" onclick="closeModal(event)">
  <div class="call-modal">
    <div class="call-modal-header">
      <h3 id="modalTitle">Call Details</h3>
      <button class="call-modal-close" onclick="document.getElementById('transcriptModal').classList.remove('active')">&times;</button>
    </div>
    <div class="call-modal-body" id="modalBody"></div>
  </div>
</div>

<style>
  .call-stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .call-stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
    text-align: center;
  }
  .call-stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }
  .call-stat-label {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .call-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .call-card {
    display: flex;
    align-items: center;
    gap: 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
  }
  .call-card:hover {
    border-color: var(--blue);
    background: rgba(59,130,246,0.04);
  }

  .call-icon {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .call-icon.completed { background: rgba(16,185,129,0.15); color: var(--green); }
  .call-icon.no_answer { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .call-icon.voicemail { background: rgba(139,92,246,0.15); color: #8b5cf6; }
  .call-icon.busy { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .call-icon.failed { background: rgba(239,68,68,0.15); color: var(--red); }
  .call-icon.initiated { background: rgba(59,130,246,0.15); color: var(--blue); }
  .call-icon.ringing { background: rgba(59,130,246,0.15); color: var(--blue); }
  .call-icon.answered { background: rgba(16,185,129,0.15); color: var(--green); }

  .call-info {
    flex: 1;
    min-width: 0;
  }
  .call-info-top {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 3px;
  }
  .call-lead-name {
    font-weight: 600;
    color: var(--text);
    font-size: 14px;
  }
  .call-company {
    color: var(--text-dim);
    font-size: 12px;
  }
  .call-summary {
    font-size: 12px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 500px;
  }

  .call-tags {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .call-tag {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .call-tag-ai { background: rgba(139,92,246,0.15); color: #a78bfa; }
  .call-tag-manual { background: rgba(59,130,246,0.15); color: #60a5fa; }
  .call-tag-inbound { background: rgba(16,185,129,0.15); color: #34d399; }
  .call-tag-browser { background: rgba(245,158,11,0.15); color: #fbbf24; }

  .call-outcome-col {
    min-width: 110px;
    flex-shrink: 0;
    text-align: center;
  }
  .call-outcome-tag {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
  }
  .outcome-qualified { background: rgba(16,185,129,0.15); color: var(--green); }
  .outcome-not_qualified { background: rgba(239,68,68,0.1); color: var(--red); }
  .outcome-not_interested { background: rgba(234,88,12,0.12); color: var(--orange); }
  .outcome-callback { background: rgba(59,130,246,0.15); color: var(--blue); }
  .outcome-voicemail { background: rgba(139,92,246,0.12); color: #8b5cf6; }
  .outcome-no_answer { background: rgba(245,158,11,0.12); color: var(--yellow); }
  .outcome-wrong_number { background: rgba(239,68,68,0.1); color: var(--red); }
  .outcome-busy { background: rgba(245,158,11,0.08); color: var(--yellow); }
  .outcome-gatekeeper { background: rgba(147,51,234,0.12); color: var(--purple); }
  .outcome-transferred_to_david { background: rgba(16,185,129,0.15); color: var(--green); }
  .outcome-transferred_to_market_manager { background: rgba(59,130,246,0.15); color: var(--blue); }
  .outcome-transferred_to_marie { background: rgba(139,92,246,0.15); color: #a78bfa; }
  .outcome-learned_about_breasy { background: rgba(59,130,246,0.15); color: var(--blue); }
  .outcome-existing_customer { background: rgba(139,92,246,0.12); color: #8b5cf6; }
  .outcome-not_interested { background: rgba(234,88,12,0.12); color: var(--orange); }
  .outcome-spam { background: rgba(239,68,68,0.1); color: var(--red); }
  .outcome-other { background: rgba(255,255,255,0.08); color: var(--text-dim); }
  .outcome-unknown { background: rgba(255,255,255,0.05); color: var(--text-dim); }
  .outcome-none { background: rgba(255,255,255,0.05); color: var(--text-dim); }

  .call-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    flex-shrink: 0;
    min-width: 80px;
  }
  .call-duration {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    font-variant-numeric: tabular-nums;
  }
  .call-time {
    font-size: 11px;
    color: var(--text-dim);
  }

  .call-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }
  .call-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.15s;
  }
  .call-action-btn:hover {
    border-color: var(--blue);
    color: var(--blue);
    background: rgba(59,130,246,0.06);
  }

  /* Modal */
  .call-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .call-modal-overlay.active {
    display: flex;
  }
  .call-modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }
  .call-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .call-modal-header h3 {
    margin: 0;
    font-size: 16px;
  }
  .call-modal-close {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 22px;
    cursor: pointer;
    padding: 0 4px;
    line-height: 1;
  }
  .call-modal-close:hover { color: var(--text); }
  .call-modal-body {
    padding: 20px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text);
  }
  .modal-section {
    margin-bottom: 16px;
  }
  .modal-section-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 6px;
    font-weight: 600;
  }
  .modal-transcript {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    max-height: 400px;
    overflow-y: auto;
    font-size: 13px;
  }
  .transcript-msg {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
  }
  .transcript-msg:last-child { margin-bottom: 0; }
  .transcript-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
    font-weight: 700;
  }
  .transcript-avatar.ai { background: rgba(139,92,246,0.2); color: #a78bfa; }
  .transcript-avatar.user { background: rgba(59,130,246,0.2); color: #60a5fa; }
  .transcript-avatar.system { background: rgba(245,158,11,0.15); color: #fbbf24; }
  .transcript-bubble {
    flex: 1;
    min-width: 0;
  }
  .transcript-speaker {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 2px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
  }
  .transcript-speaker.ai { color: #a78bfa; }
  .transcript-speaker.user { color: #60a5fa; }
  .transcript-speaker.system { color: #fbbf24; }
  .transcript-text {
    color: var(--text);
    line-height: 1.5;
    word-break: break-word;
  }
  .modal-recording {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
  }
  .modal-recording audio {
    width: 100%;
    height: 36px;
  }
  .modal-recording-url {
    display: block;
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
    word-break: break-all;
  }
  .modal-recording-url a { color: var(--blue); text-decoration: none; }
  .modal-recording-url a:hover { text-decoration: underline; }
  .fetch-vapi-btn {
    background: rgba(139,92,246,0.15);
    color: #a78bfa;
    border: 1px solid rgba(139,92,246,0.3);
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .fetch-vapi-btn:hover {
    background: rgba(139,92,246,0.25);
    border-color: rgba(139,92,246,0.5);
  }
  .fetch-vapi-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .modal-meta-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 16px;
  }
  .modal-meta-item {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }
  .modal-meta-key {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    font-weight: 600;
  }
  .modal-meta-val {
    font-size: 13px;
    color: var(--text);
    font-weight: 500;
  }

  /* Phone Lookup */
  .lookup-btn {
    background: rgba(59,130,246,0.15);
    color: var(--blue);
    border: 1px solid rgba(59,130,246,0.3);
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .lookup-btn:hover { background: rgba(59,130,246,0.25); border-color: rgba(59,130,246,0.5); }
  .lookup-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .lookup-results { margin-top: 16px; }
  .lookup-field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
  .lookup-field label {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px;
    color: var(--text-dim); font-weight: 600;
  }
  .lookup-field input {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 10px; color: var(--text); font-size: 13px; width: 100%; box-sizing: border-box;
  }
  .lookup-field input:focus { outline: none; border-color: var(--blue); }
  .lookup-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .lookup-sources { display: flex; gap: 6px; margin-top: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .lookup-source-tag { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .lookup-source-tag.found { background: rgba(16,185,129,0.15); color: var(--green); }
  .lookup-source-tag.missed { background: rgba(255,255,255,0.05); color: var(--text-dim); }
  .save-lead-btn {
    background: var(--green); color: #fff; border: none; border-radius: 8px;
    padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer;
    width: 100%; margin-top: 12px; transition: opacity 0.15s;
  }
  .save-lead-btn:hover { opacity: 0.9; }
  .save-lead-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .lookup-loading { text-align: center; padding: 30px; color: var(--text-dim); }
  .lookup-spinner {
    display: inline-block; width: 24px; height: 24px;
    border: 3px solid var(--border); border-top-color: var(--blue);
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .lookup-snippets {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px; max-height: 120px; overflow-y: auto;
    font-size: 12px; color: var(--text-dim); line-height: 1.5; margin-top: 8px;
  }

  @media (max-width: 768px) {
    .call-stats-row { grid-template-columns: repeat(2, 1fr); }
    .call-card { flex-wrap: wrap; }
    .call-summary { max-width: 200px; }
    .call-tags { order: 5; width: 100%; margin-top: 6px; }
    .lookup-row { grid-template-columns: 1fr; }
  }
</style>

<script>
let currentPage = 1;
let allCallsCache = [];

function changePage(delta) {
  currentPage += delta;
  if (currentPage < 1) currentPage = 1;
  loadCallLog();
}

function formatDuration(secs) {
  if (!secs) return '—';
  if (secs < 60) return secs + 's';
  return Math.floor(secs / 60) + 'm ' + (secs % 60) + 's';
}

function timeAgo(date) {
  const secs = Math.floor((new Date() - date) / 1000);
  if (secs < 60) return 'now';
  if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
  if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
  if (secs < 604800) return Math.floor(secs / 86400) + 'd ago';
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

function statusIcon(status) {
  const icons = {
    completed: '&#10003;',
    answered: '&#10003;',
    no_answer: '&#8635;',
    voicemail: '&#9993;',
    busy: '&#8226;',
    failed: '&#10007;',
    initiated: '&#8594;',
    ringing: '&#9743;',
  };
  return icons[status] || '&#9742;';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function closeModal(e) {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('active');
  }
}

function formatTranscript(text) {
  if (!text) return '';
  // Parse "AI: ...\nUser: ..." format from Vapi
  const lines = text.split('\n').filter(l => l.trim());
  let html = '';
  let currentSpeaker = null;
  let currentText = '';

  function flushMessage() {
    if (!currentSpeaker || !currentText.trim()) return;
    const role = currentSpeaker.toLowerCase().includes('ai') || currentSpeaker.toLowerCase().includes('bot') || currentSpeaker.toLowerCase().includes('assistant')
      ? 'ai'
      : currentSpeaker.toLowerCase().includes('system') ? 'system' : 'user';
    const avatar = role === 'ai' ? '&#129302;' : role === 'system' ? '&#9881;' : '&#128100;';
    const label = role === 'ai' ? 'AI Agent' : role === 'system' ? 'System' : 'Caller';
    html += `<div class="transcript-msg">
      <div class="transcript-avatar ${role}">${avatar}</div>
      <div class="transcript-bubble">
        <div class="transcript-speaker ${role}">${label}</div>
        <div class="transcript-text">${escapeHtml(currentText.trim())}</div>
      </div>
    </div>`;
  }

  for (const line of lines) {
    const match = line.match(/^(AI|User|Bot|Assistant|System)\s*:\s*(.*)$/i);
    if (match) {
      flushMessage();
      currentSpeaker = match[1];
      currentText = match[2];
    } else {
      currentText += ' ' + line;
    }
  }
  flushMessage();

  // If no structured messages found, show as plain text
  if (!html) {
    html = `<div class="transcript-text" style="white-space:pre-wrap;">${escapeHtml(text)}</div>`;
  }
  return html;
}

function showCallDetails(callId) {
  const c = allCallsCache.find(x => x.id === callId);
  if (!c) return;

  const leadName = c.first_name ? `${c.first_name} ${c.last_name || ''}`.trim() : (c.operator_phone || c.phone || 'Unknown Caller');
  document.getElementById('modalTitle').textContent =
    `${leadName} — ${(c.call_type || '').replace(/_/g, ' ').toUpperCase()} Call`;

  let body = '';

  // Meta info grid
  body += `<div class="modal-section">
    <div class="modal-meta-grid">
      ${c.operator_phone ? `<div class="modal-meta-item"><span class="modal-meta-key">Phone</span><span class="modal-meta-val">${escapeHtml(c.operator_phone)}</span></div>` : ''}
      ${c.outcome ? `<div class="modal-meta-item"><span class="modal-meta-key">Outcome</span><span class="modal-meta-val"><span class="call-outcome-tag outcome-${c.outcome}">${(c.outcome || '').replace(/_/g, ' ')}</span></span></div>` : ''}
      ${c.interest_level && c.interest_level !== 'none' ? `<div class="modal-meta-item"><span class="modal-meta-key">Interest</span><span class="modal-meta-val">${c.interest_level}</span></div>` : ''}
      ${c.duration_seconds ? `<div class="modal-meta-item"><span class="modal-meta-key">Duration</span><span class="modal-meta-val">${formatDuration(c.duration_seconds)}</span></div>` : ''}
      ${c.status ? `<div class="modal-meta-item"><span class="modal-meta-key">Status</span><span class="modal-meta-val">${(c.status || '').replace(/_/g, ' ')}</span></div>` : ''}
    </div>
  </div>`;

  if (c.summary) {
    body += `<div class="modal-section">
      <div class="modal-section-label">Summary</div>
      <div>${escapeHtml(c.summary)}</div>
    </div>`;
  }

  if (c.objections) {
    body += `<div class="modal-section">
      <div class="modal-section-label">Objections</div>
      <div>${escapeHtml(c.objections)}</div>
    </div>`;
  }

  // Recording
  if (c.recording_url) {
    body += `<div class="modal-section">
      <div class="modal-section-label">Recording</div>
      <div class="modal-recording">
        <audio controls src="${escapeHtml(c.recording_url)}" preload="none"></audio>
        <span class="modal-recording-url"><a href="${escapeHtml(c.recording_url)}" target="_blank">Open recording &#8599;</a></span>
      </div>
    </div>`;
  }

  // Transcript
  if (c.transcript) {
    body += `<div class="modal-section">
      <div class="modal-section-label">Transcript</div>
      <div class="modal-transcript">${formatTranscript(c.transcript)}</div>
    </div>`;
  }

  // Fetch from Vapi button (for calls with a vapi call_sid)
  const isVapiCall = c.call_sid && !c.call_sid.startsWith('dev_');
  if (isVapiCall) {
    const hasData = c.transcript || c.recording_url;
    body += `<div class="modal-section" style="text-align:center;padding-top:8px;">
      <button class="fetch-vapi-btn" id="fetchVapiBtn" onclick="fetchFromVapi(${c.id})">
        &#8635; ${hasData ? 'Refresh from Vapi' : 'Fetch Transcript from Vapi'}
      </button>
    </div>`;
  }

  // Research Caller button — for inbound calls with no lead
  if (!c.lead_id && c.operator_phone && c.operator_phone !== 'unknown') {
    body += `<div class="modal-section" id="lookupSection">
      <div style="text-align:center; padding-top:4px;">
        <button class="lookup-btn" id="lookupBtn" onclick="event.stopPropagation(); researchCaller(${c.id}, '${escapeHtml(c.operator_phone)}')">
          &#128269; Research Caller
        </button>
        <div style="font-size:11px; color:var(--text-dim); margin-top:4px;">
          Look up ${escapeHtml(c.operator_phone)} across Twilio, Google &amp; Google Maps
        </div>
      </div>
    </div>`;
  }

  if (!c.summary && !c.transcript && !c.recording_url && !isVapiCall && !(!c.lead_id && c.operator_phone)) {
    body = '<div style="color:var(--text-dim);text-align:center;padding:20px;">No details available for this call.</div>';
  }

  document.getElementById('modalBody').innerHTML = body;
  document.getElementById('transcriptModal').classList.add('active');
}

async function fetchFromVapi(callLogId) {
  const btn = document.getElementById('fetchVapiBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '&#8987; Fetching...'; }

  try {
    const res = await fetch(`/api/dashboard/sync-vapi-transcript/${callLogId}`, { method: 'POST' });
    const data = await res.json();

    if (!data.success) {
      alert('Failed: ' + (data.error || 'Unknown error'));
      if (btn) { btn.disabled = false; btn.innerHTML = '&#8635; Retry'; }
      return;
    }

    // Update the cached call data
    const idx = allCallsCache.findIndex(x => x.id === callLogId);
    if (idx >= 0) {
      if (data.transcript) allCallsCache[idx].transcript = data.transcript;
      if (data.recordingUrl) allCallsCache[idx].recording_url = data.recordingUrl;
      if (data.summary) allCallsCache[idx].summary = data.summary;
      if (data.duration) allCallsCache[idx].duration_seconds = data.duration;
    }

    // Re-render modal with updated data
    showCallDetails(callLogId);
  } catch (e) {
    alert('Error fetching from Vapi: ' + e.message);
    if (btn) { btn.disabled = false; btn.innerHTML = '&#8635; Retry'; }
  }
}

async function researchCaller(callLogId, phone) {
  const btn = document.getElementById('lookupBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '&#8987; Researching...'; }

  const section = document.getElementById('lookupSection');
  section.innerHTML = `
    <div class="lookup-loading">
      <div class="lookup-spinner"></div>
      <div style="margin-top:10px;">Searching for ${escapeHtml(phone)}...</div>
      <div style="font-size:11px; color:var(--text-dim); margin-top:4px;">
        Checking Twilio, Google Search &amp; Google Maps. This may take 15-30 seconds.
      </div>
    </div>`;

  try {
    const res = await fetch('/api/leads/phone-lookup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone }),
    });
    const data = await res.json();

    if (res.status === 409) {
      section.innerHTML = `
        <div class="modal-section">
          <div style="background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:8px; padding:14px; text-align:center;">
            <div style="font-weight:600; margin-bottom:6px;">Lead Already Exists</div>
            <div style="font-size:13px; color:var(--text-dim);">
              ${escapeHtml(data.existing_lead?.company_name || '')} — ${escapeHtml(data.existing_lead?.first_name || '')} ${escapeHtml(data.existing_lead?.last_name || '')}
            </div>
            <a href="/lead/${data.existing_lead?.id}" class="lookup-btn" style="margin-top:10px; text-decoration:none; display:inline-flex;">
              View Lead &#8599;
            </a>
          </div>
        </div>`;
      return;
    }

    if (!data.success) {
      section.innerHTML = `<div style="color:var(--red); text-align:center; padding:16px;">
        Error: ${escapeHtml(data.error || 'Lookup failed')}
      </div>`;
      return;
    }

    showLookupResults(callLogId, data.results);
  } catch (e) {
    section.innerHTML = `<div style="color:var(--red); text-align:center; padding:16px;">
      Error: ${escapeHtml(e.message)}
    </div>`;
  }
}

function showLookupResults(callLogId, r) {
  const section = document.getElementById('lookupSection');

  const sourceTags = r.sources_checked.map(s => {
    const found = (s === 'twilio' && r.twilio_found) ||
                  (s === 'google_search' && r.google_search_found) ||
                  (s === 'google_maps' && r.google_maps_found);
    const label = s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    return `<span class="lookup-source-tag ${found ? 'found' : 'missed'}">
      ${found ? '&#10003;' : '&#10007;'} ${label}
    </span>`;
  }).join('');

  const nothingFound = !r.company_name && !r.first_name && !r.website && !r.email;

  section.innerHTML = `
    <div class="modal-section-label">Phone Lookup Results</div>
    <div class="lookup-sources">${sourceTags}</div>
    ${nothingFound ? `
      <div style="text-align:center; padding:12px; color:var(--text-dim); font-size:12px;">
        No information found for this number. You can fill in the fields manually.
      </div>` : ''}
    <div class="lookup-results">
      <div class="lookup-row">
        <div class="lookup-field">
          <label>First Name</label>
          <input type="text" id="lk_first_name" value="${escapeHtml(r.first_name || '')}" />
        </div>
        <div class="lookup-field">
          <label>Last Name</label>
          <input type="text" id="lk_last_name" value="${escapeHtml(r.last_name || '')}" />
        </div>
      </div>
      <div class="lookup-field">
        <label>Company Name</label>
        <input type="text" id="lk_company_name" value="${escapeHtml(r.company_name || '')}" />
      </div>
      <div class="lookup-row">
        <div class="lookup-field">
          <label>Email</label>
          <input type="email" id="lk_email" value="${escapeHtml(r.email || '')}" />
        </div>
        <div class="lookup-field">
          <label>Website</label>
          <input type="text" id="lk_website" value="${escapeHtml(r.website || '')}" />
        </div>
      </div>
      <div class="lookup-row">
        <div class="lookup-field">
          <label>City</label>
          <input type="text" id="lk_city" value="${escapeHtml(r.city || '')}" />
        </div>
        <div class="lookup-field">
          <label>State</label>
          <input type="text" id="lk_state" value="${escapeHtml(r.state || '')}" />
        </div>
      </div>
      <div class="lookup-row">
        <div class="lookup-field">
          <label>Industry</label>
          <input type="text" id="lk_industry" value="${escapeHtml(r.industry || '')}" />
        </div>
        <div class="lookup-field">
          <label>Phone Type</label>
          <input type="text" id="lk_phone_type" value="${escapeHtml(r.phone_line_type || '')}" readonly style="opacity:0.7;" />
        </div>
      </div>
      ${r.rating ? `
        <div class="lookup-row">
          <div class="lookup-field">
            <label>Google Rating</label>
            <input type="text" id="lk_rating" value="${r.rating}" readonly style="opacity:0.7;" />
          </div>
          <div class="lookup-field">
            <label>Reviews</label>
            <input type="text" id="lk_review_count" value="${r.review_count || 0}" readonly style="opacity:0.7;" />
          </div>
        </div>` : ''}
      ${r.snippets && r.snippets.length > 0 ? `
        <div class="modal-section-label" style="margin-top:12px;">Google Search Snippets</div>
        <div class="lookup-snippets">
          ${r.snippets.map(s => '<div style="margin-bottom:6px;">&bull; ' + escapeHtml(s) + '</div>').join('')}
        </div>` : ''}
      <button class="save-lead-btn" id="saveLeadBtn" onclick="saveAsLead(${callLogId}, '${escapeHtml(r.phone)}', ${r.rating || 0}, ${r.review_count || 0})">
        Save as Lead
      </button>
    </div>`;
}

async function saveAsLead(callLogId, phone, rating, reviewCount) {
  const btn = document.getElementById('saveLeadBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }

  const payload = {
    phone,
    first_name: document.getElementById('lk_first_name')?.value || '',
    last_name: document.getElementById('lk_last_name')?.value || '',
    company_name: document.getElementById('lk_company_name')?.value || '',
    email: document.getElementById('lk_email')?.value || '',
    website: document.getElementById('lk_website')?.value || '',
    city: document.getElementById('lk_city')?.value || '',
    state: document.getElementById('lk_state')?.value || '',
    industry: document.getElementById('lk_industry')?.value || '',
    phone_line_type: document.getElementById('lk_phone_type')?.value || '',
    rating,
    review_count: reviewCount,
    call_log_id: callLogId,
  };

  try {
    const res = await fetch('/api/leads/create-from-lookup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();

    if (res.status === 409) {
      alert('Lead already exists for this phone number.');
      if (btn) { btn.disabled = false; btn.textContent = 'Save as Lead'; }
      return;
    }

    if (!data.success) {
      alert('Error: ' + (data.error || 'Failed to create lead'));
      if (btn) { btn.disabled = false; btn.textContent = 'Save as Lead'; }
      return;
    }

    const lead = data.lead;

    // Update cached call data
    const idx = allCallsCache.findIndex(x => x.id === callLogId);
    if (idx >= 0) {
      allCallsCache[idx].lead_id = lead.id;
      allCallsCache[idx].first_name = lead.first_name;
      allCallsCache[idx].last_name = lead.last_name;
      allCallsCache[idx].company_name = lead.company_name;
    }

    // Show success
    const section = document.getElementById('lookupSection');
    section.innerHTML = `
      <div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); border-radius:8px; padding:16px; text-align:center;">
        <div style="font-size:18px; margin-bottom:6px;">&#10003;</div>
        <div style="font-weight:600; margin-bottom:4px;">Lead Created Successfully</div>
        <div style="font-size:12px; color:var(--text-dim); margin-bottom:10px;">
          ${escapeHtml(lead.company_name || '')} ${lead.first_name ? '— ' + escapeHtml(lead.first_name) + ' ' + escapeHtml(lead.last_name || '') : ''}
          | Grade: ${escapeHtml(data._scoring?.qualification_grade || 'N/A')}
        </div>
        <a href="/lead/${lead.id}" class="lookup-btn" style="text-decoration:none; display:inline-flex;">
          View Lead &#8599;
        </a>
      </div>`;

    // Reload call list so card shows lead name
    loadCallLog();
  } catch (e) {
    alert('Error: ' + e.message);
    if (btn) { btn.disabled = false; btn.textContent = 'Save as Lead'; }
  }
}

async function loadCallLog() {
  const callType = document.getElementById('typeFilter').value;
  const status = document.getElementById('statusFilter').value;
  const outcome = document.getElementById('outcomeFilter').value;

  let url = `/api/leads/call-log?page=${currentPage}&limit=50`;
  if (callType) url += `&call_type=${callType}`;
  if (status) url += `&status=${status}`;
  if (outcome) url += `&outcome=${outcome}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    const container = document.getElementById('callList');

    allCallsCache = data.calls || [];

    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${Math.ceil(data.total / 50) || 1}`;
    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage * 50 >= data.total;

    // Stats
    document.getElementById('statTotal').textContent = data.total || 0;
    const connected = allCallsCache.filter(c => c.status === 'completed' || c.status === 'answered').length;
    document.getElementById('statConnected').textContent = connected;
    const durations = allCallsCache.filter(c => c.duration_seconds > 0).map(c => c.duration_seconds);
    const avgDur = durations.length ? Math.round(durations.reduce((a, b) => a + b, 0) / durations.length) : 0;
    document.getElementById('statAvgDuration').textContent = formatDuration(avgDur);
    const qualified = allCallsCache.filter(c => c.outcome === 'qualified').length;
    document.getElementById('statQualified').textContent = qualified;

    if (!data.calls.length) {
      container.innerHTML = '<div class="inbox-empty" style="padding:40px;">No calls found.</div>';
      return;
    }

    container.innerHTML = data.calls.map(c => {
      const typeTag = {
        ai: '<span class="call-tag call-tag-ai">AI</span>',
        manual: '<span class="call-tag call-tag-manual">Manual</span>',
        inbound: '<span class="call-tag call-tag-inbound">Inbound</span>',
        browser: '<span class="call-tag call-tag-browser">Browser</span>',
      }[c.call_type] || '<span class="call-tag">' + (c.call_type || '') + '</span>';

      const outcomeLabel = c.outcome ? c.outcome.replace(/_/g, ' ') : '—';
      const outcomeCls = c.outcome ? 'outcome-' + c.outcome : 'outcome-none';
      const outcomeTag = `<span class="call-outcome-tag ${outcomeCls}">${outcomeLabel}</span>`;

      const summary = c.summary
        ? escapeHtml(c.summary.substring(0, 80) + (c.summary.length > 80 ? '...' : ''))
        : (c.status || '').replace(/_/g, ' ');

      const time = timeAgo(new Date(c.created_at + 'Z'));
      const statusCls = c.status || 'initiated';
      const hasDetails = c.transcript || c.summary || c.recording_url;

      const displayName = c.first_name ? (c.first_name + ' ' + (c.last_name || '')).trim() : (c.operator_phone || c.phone || 'Unknown Caller');
      const cardClick = c.lead_id ? `window.location='/lead/${c.lead_id}'` : `event.stopPropagation();showCallDetails(${c.id})`;

      return `<div class="call-card" onclick="${cardClick}">
        <div class="call-icon ${statusCls}">${statusIcon(c.status)}</div>
        <div class="call-info">
          <div class="call-info-top">
            <span class="call-lead-name">${escapeHtml(displayName)}</span>
            <span class="call-company">${escapeHtml(c.company_name || '')}</span>
          </div>
          <div class="call-summary">${summary}</div>
        </div>
        <div class="call-tags">
          ${typeTag}
        </div>
        <div class="call-outcome-col">
          ${outcomeTag}
        </div>
        <div class="call-meta">
          <div class="call-duration">${formatDuration(c.duration_seconds)}</div>
          <div class="call-time">${time}</div>
        </div>
        <div class="call-actions">
          ${hasDetails ? `<button class="call-action-btn" title="View details" onclick="event.stopPropagation();showCallDetails(${c.id})">&#9776;</button>` : ''}
        </div>
      </div>`;
    }).join('');
  } catch (e) { console.error('Call log error:', e); }
}

loadCallLog();
setInterval(loadCallLog, 30000);
</script>

<%- include('partials/footer') %>
