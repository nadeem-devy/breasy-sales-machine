<%- include('partials/header') %>

<div class="page-header">
  <h1>Ad Campaigns</h1>
  <div style="display:flex;gap:8px;">
    <button class="btn btn-outline btn-sm" onclick="window.location='/ad-campaigns/track'">Track External</button>
    <button class="btn btn-primary btn-sm" onclick="window.location='/ad-campaigns/create'">Create Campaign</button>
  </div>
</div>

<!-- Overview Stats Bar -->
<div class="kpi-grid" id="adOverview" style="margin-bottom:20px;">
  <div class="kpi-card"><div class="kpi-value" id="ao-active">—</div><div class="kpi-label">Active Campaigns</div></div>
  <div class="kpi-card"><div class="kpi-value" id="ao-spend">—</div><div class="kpi-label">Total Spend</div></div>
  <div class="kpi-card"><div class="kpi-value" id="ao-leads">—</div><div class="kpi-label">Leads Captured</div></div>
  <div class="kpi-card"><div class="kpi-value" id="ao-cpl">—</div><div class="kpi-label">Avg CPL</div></div>
</div>

<!-- Type Filter -->
<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
  <button class="btn btn-sm type-tab active" data-type="" onclick="filterType('')">All</button>
  <button class="btn btn-sm type-tab" data-type="created" onclick="filterType('created')">Created</button>
  <button class="btn btn-sm type-tab" data-type="external" onclick="filterType('external')">External</button>
</div>

<!-- Platform Filter Tabs -->
<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;">
  <button class="btn btn-sm platform-tab active" data-platform="" onclick="filterPlatform('')">All Platforms</button>
  <button class="btn btn-sm platform-tab" data-platform="facebook" onclick="filterPlatform('facebook')">Facebook</button>
  <button class="btn btn-sm platform-tab" data-platform="instagram" onclick="filterPlatform('instagram')">Instagram</button>
  <button class="btn btn-sm platform-tab" data-platform="google" onclick="filterPlatform('google')">Google</button>
  <button class="btn btn-sm platform-tab" data-platform="linkedin" onclick="filterPlatform('linkedin')">LinkedIn</button>
  <button class="btn btn-sm platform-tab" data-platform="reddit" onclick="filterPlatform('reddit')">Reddit</button>
</div>

<!-- Campaign Cards -->
<div id="campaignCards" class="grid-2" style="gap:16px;">
  <div class="card" style="padding:40px;text-align:center;color:var(--text-dim);">Loading campaigns...</div>
</div>

<style>
  .type-tab { background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-dim); }
  .type-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .platform-tab { background: var(--bg-hover); border: 1px solid var(--border); color: var(--text-dim); }
  .platform-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

  .ad-badge-external { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 7px; border-radius: 4px; background: rgba(168,85,247,0.15); color: #a855f7; margin-left: 6px; }
  .ad-badge-tracking { font-size: 10px; color: var(--text-dim); margin-top: 4px; display: flex; align-items: center; gap: 4px; }

  .ad-card { border: 1px solid var(--border); border-radius: 10px; padding: 20px; background: var(--bg-card); cursor: pointer; transition: border-color 0.15s; }
  .ad-card:hover { border-color: var(--accent); }

  .ad-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .ad-card-name { font-size: 16px; font-weight: 700; }
  .ad-card-platform { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; padding: 3px 8px; border-radius: 4px; }
  .ad-card-platform.p-facebook { background: rgba(24,119,242,0.15); color: #1877f2; }
  .ad-card-platform.p-instagram { background: rgba(225,48,108,0.15); color: #e1306c; }
  .ad-card-platform.p-google { background: rgba(66,133,244,0.15); color: #4285f4; }
  .ad-card-platform.p-linkedin { background: rgba(10,102,194,0.15); color: #0a66c2; }
  .ad-card-platform.p-reddit { background: rgba(255,69,0,0.15); color: #ff4500; }

  .ad-status { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 12px; }
  .ad-status.s-draft { background: rgba(148,163,184,0.15); color: #94a3b8; }
  .ad-status.s-pending { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .ad-status.s-active { background: rgba(22,163,74,0.15); color: #16a34a; }
  .ad-status.s-paused { background: rgba(249,115,22,0.15); color: #f97316; }
  .ad-status.s-completed { background: rgba(59,130,246,0.15); color: #3b82f6; }
  .ad-status.s-error { background: rgba(239,68,68,0.15); color: #ef4444; }

  .ad-card-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px; }
  .ad-metric { text-align: center; padding: 8px; background: var(--bg-hover); border-radius: 6px; }
  .ad-metric-value { font-size: 16px; font-weight: 700; }
  .ad-metric-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.3px; }

  .ad-card-budget { font-size: 13px; color: var(--text-dim); margin-top: 8px; }
</style>

<script>
let currentPlatform = '';
let currentType = '';

function filterType(type) {
  currentType = type;
  document.querySelectorAll('.type-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.type === type);
  });
  loadCampaigns();
}

function filterPlatform(platform) {
  currentPlatform = platform;
  document.querySelectorAll('.platform-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.platform === platform);
  });
  loadCampaigns();
}

function fmtMoney(n) { return '$' + (n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function fmtNum(n) { return (n || 0).toLocaleString(); }

async function loadOverview() {
  try {
    const res = await fetch('/api/ad-campaigns/overview');
    const d = await res.json();
    document.getElementById('ao-active').textContent = d.active_campaigns || 0;
    document.getElementById('ao-spend').textContent = fmtMoney(d.total_spend);
    document.getElementById('ao-leads').textContent = fmtNum(d.total_leads);
    document.getElementById('ao-cpl').textContent = fmtMoney(d.avg_cpl);
  } catch (e) { console.error('Overview error:', e); }
}

async function loadCampaigns() {
  try {
    var params = [];
    if (currentPlatform) params.push('platform=' + currentPlatform);
    if (currentType === 'external') params.push('is_external=1');
    else if (currentType === 'created') params.push('is_external=0');
    var url = '/api/ad-campaigns' + (params.length ? '?' + params.join('&') : '');

    const res = await fetch(url);
    const campaigns = await res.json();
    const el = document.getElementById('campaignCards');

    if (!campaigns.length) {
      el.textContent = '';
      var empty = document.createElement('div');
      empty.className = 'card';
      empty.style.cssText = 'padding:40px;text-align:center;color:var(--text-dim);grid-column:1/-1;';
      empty.textContent = 'No campaigns yet. Click "Create Campaign" or "Track External" to get started.';
      el.appendChild(empty);
      return;
    }

    el.textContent = '';
    campaigns.forEach(function(c) {
      var card = document.createElement('div');
      card.className = 'ad-card';
      card.onclick = function() { window.location = '/ad-campaigns/' + c.id; };

      var header = document.createElement('div');
      header.className = 'ad-card-header';

      var left = document.createElement('div');
      var nameDiv = document.createElement('div');
      nameDiv.className = 'ad-card-name';
      nameDiv.textContent = c.name || '';
      if (c.is_external) {
        var extBadge = document.createElement('span');
        extBadge.className = 'ad-badge-external';
        extBadge.textContent = 'External';
        nameDiv.appendChild(extBadge);
      }
      left.appendChild(nameDiv);

      var platSpan = document.createElement('span');
      platSpan.className = 'ad-card-platform p-' + c.platform;
      platSpan.textContent = c.platform;
      left.appendChild(platSpan);

      if (c.tracking_url) {
        var trackDiv = document.createElement('div');
        trackDiv.className = 'ad-badge-tracking';
        trackDiv.textContent = '\u{1F517} Tracking link active';
        left.appendChild(trackDiv);
      }

      var statusSpan = document.createElement('span');
      statusSpan.className = 'ad-status s-' + c.status;
      statusSpan.textContent = c.status;

      header.appendChild(left);
      header.appendChild(statusSpan);
      card.appendChild(header);

      var metrics = document.createElement('div');
      metrics.className = 'ad-card-metrics';
      [
        { val: fmtNum(c.impressions), label: 'Impressions' },
        { val: fmtNum(c.clicks), label: 'Clicks' },
        { val: (c.leads_captured || 0).toString(), label: 'Leads' },
        { val: fmtMoney(c.cpl), label: 'CPL' },
      ].forEach(function(m) {
        var metric = document.createElement('div');
        metric.className = 'ad-metric';
        var mv = document.createElement('div');
        mv.className = 'ad-metric-value';
        mv.textContent = m.val;
        var ml = document.createElement('div');
        ml.className = 'ad-metric-label';
        ml.textContent = m.label;
        metric.appendChild(mv);
        metric.appendChild(ml);
        metrics.appendChild(metric);
      });
      card.appendChild(metrics);

      var budget = document.createElement('div');
      budget.className = 'ad-card-budget';
      budget.textContent = 'Budget: ' + fmtMoney(c.daily_budget) + '/day | Spent: ' + fmtMoney(c.spend);
      if (c.manual_metrics) {
        var manualSpan = document.createElement('span');
        manualSpan.style.cssText = 'margin-left:8px;font-size:11px;color:var(--yellow);';
        manualSpan.textContent = '\u270E Manual';
        budget.appendChild(manualSpan);
      }
      if (c.error_message) {
        var errBr = document.createElement('br');
        var errSpan = document.createElement('span');
        errSpan.style.cssText = 'color:var(--red);font-size:12px;';
        errSpan.textContent = 'Error: ' + c.error_message;
        budget.appendChild(errBr);
        budget.appendChild(errSpan);
      }
      card.appendChild(budget);

      el.appendChild(card);
    });
  } catch (e) {
    console.error('Load campaigns error:', e);
  }
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

loadOverview();
loadCampaigns();
</script>

<%- include('partials/footer') %>
