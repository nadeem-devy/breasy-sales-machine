<%- include('partials/header') %>

<div class="page-header">
  <h1 id="campaignName">Ad Campaign</h1>
  <div class="btn-group">
    <button class="btn btn-outline btn-sm" onclick="window.location='/ad-campaigns'">Back</button>
    <button class="btn btn-sm" id="pauseResumeBtn" style="display:none;" onclick="toggleCampaign()">Pause</button>
  </div>
</div>

<!-- Status + Platform badge -->
<div style="display:flex;gap:10px;align-items:center;margin-bottom:20px;" id="campaignBadges"></div>

<!-- Metrics Cards -->
<div class="kpi-grid" id="metricsCards">
  <div class="kpi-card"><div class="kpi-value" id="m-impressions">—</div><div class="kpi-label">Impressions</div></div>
  <div class="kpi-card"><div class="kpi-value" id="m-clicks">—</div><div class="kpi-label">Clicks</div></div>
  <div class="kpi-card"><div class="kpi-value" id="m-ctr">—</div><div class="kpi-label">CTR</div></div>
  <div class="kpi-card"><div class="kpi-value" id="m-spend">—</div><div class="kpi-label">Spend</div></div>
  <div class="kpi-card"><div class="kpi-value" id="m-leads">—</div><div class="kpi-label">Leads</div></div>
  <div class="kpi-card"><div class="kpi-value" id="m-cpl">—</div><div class="kpi-label">CPL</div></div>
</div>

<!-- External Campaign Info (shown only for external campaigns) -->
<div id="externalInfoCard" class="card" style="margin-top:20px;display:none;">
  <div class="card-header"><h3>External Campaign Tracking</h3></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:13px;">
    <div>
      <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Tracking Link</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <code id="ext-tracking-url" style="flex:1;background:var(--bg-hover);padding:6px 10px;border-radius:6px;word-break:break-all;font-size:12px;"></code>
        <button class="btn btn-sm btn-outline" id="copyTrackBtn" onclick="copyTrackingLink()">Copy</button>
      </div>
    </div>
    <div>
      <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Landing Page</div>
      <a id="ext-landing-url" href="#" target="_blank" style="color:var(--accent);word-break:break-all;font-size:12px;"></a>
    </div>
    <div>
      <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">External Campaign URL</div>
      <a id="ext-campaign-url" href="#" target="_blank" style="color:var(--accent);word-break:break-all;font-size:12px;"></a>
    </div>
    <div>
      <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Metrics Mode</div>
      <span id="ext-metrics-mode" style="font-size:12px;"></span>
    </div>
  </div>
</div>

<!-- Manual Metrics Entry (shown only for manual-mode external campaigns) -->
<div id="manualMetricsCard" class="card" style="margin-top:20px;display:none;">
  <div class="card-header"><h3>Update Metrics Manually</h3></div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
    <div class="form-group"><label>Impressions</label><input type="number" id="mm-impressions" placeholder="0"></div>
    <div class="form-group"><label>Clicks</label><input type="number" id="mm-clicks" placeholder="0"></div>
    <div class="form-group"><label>Spend ($)</label><input type="number" id="mm-spend" placeholder="0.00" step="0.01"></div>
    <div class="form-group"><label>Leads Captured</label><input type="number" id="mm-leads" placeholder="0"></div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
    <button class="btn btn-primary btn-sm" id="saveMetricsBtn" onclick="saveManualMetrics()">Save Metrics</button>
  </div>
</div>

<div class="grid-2" style="gap:20px;margin-top:20px;">
  <!-- Chart -->
  <div class="card">
    <div class="card-header"><h3>Daily Performance</h3></div>
    <canvas id="metricsChart" height="250"></canvas>
  </div>

  <!-- Campaign Details -->
  <div class="card">
    <div class="card-header"><h3>Campaign Info</h3></div>
    <div id="campaignInfo" style="font-size:13px;line-height:2;padding:0 4px;"></div>
  </div>
</div>

<!-- Tracking Visits (shown only for campaigns with tracking links) -->
<div id="trackingVisitsSection" style="display:none;margin-top:20px;">
  <div class="kpi-grid" id="visitKpis" style="margin-bottom:16px;">
    <div class="kpi-card"><div class="kpi-value" id="tv-total">0</div><div class="kpi-label">Total Visits</div></div>
    <div class="kpi-card"><div class="kpi-value" id="tv-unique">0</div><div class="kpi-label">Unique Visitors</div></div>
    <div class="kpi-card"><div class="kpi-value" id="tv-identified">0</div><div class="kpi-label">Identified</div></div>
    <div class="kpi-card"><div class="kpi-value" id="tv-mobile">0%</div><div class="kpi-label">Mobile</div></div>
    <div class="kpi-card"><div class="kpi-value" id="tv-today">0</div><div class="kpi-label">Today</div></div>
  </div>
  <div class="card">
    <div class="card-header"><h3>Tracking Visits</h3></div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Visitor</th><th>Device</th><th>Browser</th><th>OS</th><th>Source</th><th>IP</th></tr></thead>
        <tbody id="visitsTable"><tr><td colspan="7" style="color:var(--text-dim);">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Leads captured from this campaign -->
<div class="card" style="margin-top:20px;">
  <div class="card-header"><h3>Captured Leads</h3></div>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Name</th><th>Company</th><th>Phone</th><th>Email</th><th>Grade</th><th>Score</th><th>Captured</th></tr></thead>
      <tbody id="leadsTable"><tr><td colspan="7" style="color:var(--text-dim);">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<style>
  .ad-status-badge { display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:600;padding:4px 12px;border-radius:12px; }
  .ad-status-badge.s-draft { background:rgba(148,163,184,0.15);color:#94a3b8; }
  .ad-status-badge.s-pending { background:rgba(245,158,11,0.15);color:#f59e0b; }
  .ad-status-badge.s-active { background:rgba(22,163,74,0.15);color:#16a34a; }
  .ad-status-badge.s-paused { background:rgba(249,115,22,0.15);color:#f97316; }
  .ad-status-badge.s-completed { background:rgba(59,130,246,0.15);color:#3b82f6; }
  .ad-status-badge.s-error { background:rgba(239,68,68,0.15);color:#ef4444; }

  .ad-platform-badge { font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;padding:4px 10px;border-radius:4px; }
  .ad-platform-badge.p-facebook { background:rgba(24,119,242,0.15);color:#1877f2; }
  .ad-platform-badge.p-instagram { background:rgba(225,48,108,0.15);color:#e1306c; }
  .ad-platform-badge.p-google { background:rgba(66,133,244,0.15);color:#4285f4; }
  .ad-platform-badge.p-linkedin { background:rgba(10,102,194,0.15);color:#0a66c2; }
  .ad-platform-badge.p-reddit { background:rgba(255,69,0,0.15);color:#ff4500; }

  .grade-badge { display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;font-weight:700;font-size:13px; }
  .grade-A { background:rgba(22,163,74,0.15);color:#16a34a; }
  .grade-B { background:rgba(59,130,246,0.15);color:#3b82f6; }
  .grade-C { background:rgba(245,158,11,0.15);color:#f59e0b; }
  .grade-D { background:rgba(249,115,22,0.15);color:#f97316; }
  .grade-F { background:rgba(239,68,68,0.15);color:#ef4444; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const campaignId = <%= typeof adCampaignId !== 'undefined' ? adCampaignId : 0 %>;
let campaign = null;
let metricsChart = null;

function fmtMoney(n) { return '$' + (n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtNum(n) { return (n||0).toLocaleString(); }
function esc(s) { const d=document.createElement('div');d.textContent=s||'';return d.innerHTML; }

async function loadCampaign() {
  try {
    const res = await fetch('/api/ad-campaigns/' + campaignId);
    campaign = await res.json();

    document.getElementById('campaignName').textContent = campaign.name;
    var badgesEl = document.getElementById('campaignBadges');
    badgesEl.textContent = '';
    var platBadge = document.createElement('span');
    platBadge.className = 'ad-platform-badge p-' + campaign.platform;
    platBadge.textContent = campaign.platform;
    badgesEl.appendChild(platBadge);
    var statBadge = document.createElement('span');
    statBadge.className = 'ad-status-badge s-' + campaign.status;
    statBadge.textContent = campaign.status;
    badgesEl.appendChild(statBadge);
    if (campaign.is_external) {
      var extBadge = document.createElement('span');
      extBadge.style.cssText = 'font-size:11px;font-weight:700;padding:3px 8px;border-radius:4px;background:rgba(168,85,247,0.15);color:#a855f7;';
      extBadge.textContent = 'EXTERNAL';
      badgesEl.appendChild(extBadge);
    }
    if (campaign.platform_campaign_id) {
      var idSpan = document.createElement('span');
      idSpan.style.cssText = 'font-size:11px;color:var(--text-dim);';
      idSpan.textContent = 'ID: ' + campaign.platform_campaign_id;
      badgesEl.appendChild(idSpan);
    }

    // Metrics
    document.getElementById('m-impressions').textContent = fmtNum(campaign.impressions);
    document.getElementById('m-clicks').textContent = fmtNum(campaign.clicks);
    const ctr = campaign.impressions > 0 ? ((campaign.clicks / campaign.impressions) * 100).toFixed(2) + '%' : '0%';
    document.getElementById('m-ctr').textContent = ctr;
    document.getElementById('m-spend').textContent = fmtMoney(campaign.spend);
    document.getElementById('m-leads').textContent = campaign.leads_captured || 0;
    document.getElementById('m-cpl').textContent = fmtMoney(campaign.cpl);

    // Pause/Resume button
    const btn = document.getElementById('pauseResumeBtn');
    if (campaign.status === 'active') {
      btn.style.display = 'inline-flex';
      btn.textContent = 'Pause Campaign';
      btn.className = 'btn btn-danger btn-sm';
    } else if (campaign.status === 'paused') {
      btn.style.display = 'inline-flex';
      btn.textContent = 'Resume Campaign';
      btn.className = 'btn btn-success btn-sm';
    }

    // Info panel — build with DOM methods
    var infoEl = document.getElementById('campaignInfo');
    infoEl.textContent = '';
    var targeting = {};
    var creative = {};
    try { targeting = JSON.parse(campaign.targeting || '{}'); } catch(e) {}
    try { creative = JSON.parse(campaign.creative || '{}'); } catch(e) {}

    var infoItems = [
      ['Objective', campaign.objective || 'lead_generation'],
      ['Daily Budget', fmtMoney(campaign.daily_budget)],
      ['Total Budget', campaign.total_budget ? fmtMoney(campaign.total_budget) : 'Unlimited'],
      ['Start', campaign.start_date || 'Not set'],
      ['End', campaign.end_date || 'Ongoing'],
      ['Locations', (targeting.locations || []).join(', ') || 'US'],
      ['Age', (targeting.age_min || 25) + ' — ' + (targeting.age_max || 55)],
      ['Interests', (targeting.interests || []).join(', ') || 'None'],
      ['Headline', creative.headline || ''],
      ['CTA', creative.cta || 'LEARN_MORE'],
      ['Last Synced', campaign.last_synced_at || 'Never'],
    ];
    infoItems.forEach(function(item) {
      var b = document.createElement('strong');
      b.textContent = item[0] + ': ';
      infoEl.appendChild(b);
      infoEl.appendChild(document.createTextNode(item[1]));
      infoEl.appendChild(document.createElement('br'));
    });
    if (campaign.error_message) {
      var errSpan = document.createElement('span');
      errSpan.style.color = 'var(--red)';
      var errB = document.createElement('strong');
      errB.textContent = 'Error: ';
      errSpan.appendChild(errB);
      errSpan.appendChild(document.createTextNode(campaign.error_message));
      infoEl.appendChild(errSpan);
    }

    // External campaign sections
    if (campaign.is_external) {
      document.getElementById('externalInfoCard').style.display = 'block';
      if (campaign.tracking_url) {
        document.getElementById('ext-tracking-url').textContent = campaign.tracking_url;
      }
      if (campaign.landing_page_url) {
        var landLink = document.getElementById('ext-landing-url');
        landLink.textContent = campaign.landing_page_url;
        landLink.href = campaign.landing_page_url;
      }
      if (campaign.external_url) {
        var campLink = document.getElementById('ext-campaign-url');
        campLink.textContent = campaign.external_url;
        campLink.href = campaign.external_url;
      }
      var modeEl = document.getElementById('ext-metrics-mode');
      if (campaign.manual_metrics) {
        modeEl.textContent = '\u270E Manual — enter metrics below';
        modeEl.style.color = 'var(--yellow)';
        document.getElementById('manualMetricsCard').style.display = 'block';
        document.getElementById('mm-impressions').value = campaign.impressions || '';
        document.getElementById('mm-clicks').value = campaign.clicks || '';
        document.getElementById('mm-spend').value = campaign.spend || '';
        document.getElementById('mm-leads').value = campaign.leads_captured || '';
      } else {
        modeEl.textContent = '\u26A1 Auto-sync — metrics update every 5 min';
        modeEl.style.color = 'var(--green)';
      }

      if (campaign.tracking_url) {
        document.getElementById('trackingVisitsSection').style.display = 'block';
        loadTrackingVisits();
      }
    }
  } catch (e) {
    console.error('Load campaign error:', e);
  }
}

async function loadChart() {
  try {
    const res = await fetch('/api/ad-campaigns/' + campaignId + '/metrics?days=30');
    const metrics = await res.json();
    if (!metrics.length) return;

    const ctx = document.getElementById('metricsChart').getContext('2d');
    if (metricsChart) metricsChart.destroy();

    metricsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: metrics.map(m => m.date),
        datasets: [
          {
            label: 'Spend ($)',
            data: metrics.map(m => m.spend),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.1)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y',
          },
          {
            label: 'Leads',
            data: metrics.map(m => m.leads),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.1)',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
          },
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { position: 'left', title: { display: true, text: 'Spend ($)' } },
          y1: { position: 'right', title: { display: true, text: 'Leads' }, grid: { drawOnChartArea: false } },
        },
        plugins: { legend: { position: 'top' } },
      },
    });
  } catch (e) {
    console.error('Chart error:', e);
  }
}

async function loadLeads() {
  try {
    const res = await fetch('/api/leads?ad_campaign_id=' + campaignId + '&limit=50');
    const data = await res.json();
    const leads = data.leads || [];
    const tbody = document.getElementById('leadsTable');

    if (!leads.length) {
      tbody.textContent = '';
      var emptyRow = document.createElement('tr');
      var emptyTd = document.createElement('td');
      emptyTd.colSpan = 7;
      emptyTd.style.color = 'var(--text-dim)';
      emptyTd.textContent = 'No leads captured yet.';
      emptyRow.appendChild(emptyTd);
      tbody.appendChild(emptyRow);
      return;
    }

    tbody.textContent = '';
    leads.forEach(function(l) {
      var tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.onclick = function() { window.location = '/lead/' + l.id; };

      var name = [l.first_name, l.last_name].filter(Boolean).join(' ') || l.company_name || 'Unknown';
      var grade = l.qualification_grade || '\u2014';
      var gradeClass = 'ABCDF'.indexOf(grade) >= 0 ? 'grade-' + grade : '';

      var cells = [name, l.company_name || '', l.phone || '', l.email || ''];
      cells.forEach(function(val) {
        var td = document.createElement('td');
        td.textContent = val;
        tr.appendChild(td);
      });

      var gradeTd = document.createElement('td');
      var gradeSpan = document.createElement('span');
      gradeSpan.className = 'grade-badge ' + gradeClass;
      gradeSpan.textContent = grade;
      gradeTd.appendChild(gradeSpan);
      tr.appendChild(gradeTd);

      var scoreTd = document.createElement('td');
      scoreTd.textContent = (l.quality_score || l.score || 0).toString();
      tr.appendChild(scoreTd);

      var dateTd = document.createElement('td');
      dateTd.style.cssText = 'font-size:12px;color:var(--text-dim);';
      dateTd.textContent = l.created_at || '';
      tr.appendChild(dateTd);

      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('Load leads error:', e);
  }
}

async function toggleCampaign() {
  if (!campaign) return;
  const action = campaign.status === 'active' ? 'pause' : 'resume';
  if (action === 'pause' && !confirm('Pause this campaign?')) return;

  try {
    const res = await fetch('/api/ad-campaigns/' + campaignId + '/' + action, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      loadCampaign();
    } else {
      alert('Error: ' + (data.error || 'Unknown'));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function loadTrackingVisits() {
  try {
    var res = await fetch('/api/ad-campaigns/' + campaignId + '/tracking-visits?limit=100&days=30');
    var data = await res.json();

    document.getElementById('tv-total').textContent = fmtNum(data.stats.total_visits || 0);
    document.getElementById('tv-unique').textContent = fmtNum(data.stats.unique_visitors || 0);
    document.getElementById('tv-identified').textContent = fmtNum(data.stats.converted_leads || 0);
    document.getElementById('tv-today').textContent = fmtNum(data.stats.today_visits || 0);
    var mobileP = data.stats.total_visits > 0
      ? Math.round((data.stats.mobile_visits / data.stats.total_visits) * 100) + '%'
      : '0%';
    document.getElementById('tv-mobile').textContent = mobileP;

    var tbody = document.getElementById('visitsTable');
    tbody.textContent = '';

    if (!data.visits || !data.visits.length) {
      var emptyRow = document.createElement('tr');
      var emptyCell = document.createElement('td');
      emptyCell.colSpan = 7;
      emptyCell.style.color = 'var(--text-dim)';
      emptyCell.textContent = 'No tracking visits yet. Share your tracking link to start capturing data.';
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      return;
    }

    data.visits.forEach(function(v) {
      var tr = document.createElement('tr');

      // Time
      var timeTd = document.createElement('td');
      timeTd.style.fontSize = '12px';
      timeTd.textContent = v.created_at || '';
      tr.appendChild(timeTd);

      // Visitor (linked lead name or anonymous)
      var visitorTd = document.createElement('td');
      visitorTd.style.fontSize = '12px';
      if (v.lead_id && (v.lead_first_name || v.lead_last_name)) {
        var leadLink = document.createElement('a');
        leadLink.href = '/lead/' + v.lead_id;
        leadLink.style.cssText = 'color:var(--accent);font-weight:600;text-decoration:none;';
        leadLink.textContent = [v.lead_first_name, v.lead_last_name].filter(Boolean).join(' ');
        visitorTd.appendChild(leadLink);
        if (v.lead_email) {
          var emailSpan = document.createElement('div');
          emailSpan.style.cssText = 'font-size:11px;color:var(--text-dim);';
          emailSpan.textContent = v.lead_email;
          visitorTd.appendChild(emailSpan);
        }
      } else {
        var anonSpan = document.createElement('span');
        anonSpan.style.color = 'var(--text-dim)';
        anonSpan.textContent = 'Anonymous';
        visitorTd.appendChild(anonSpan);
      }
      tr.appendChild(visitorTd);

      // Device, Browser, OS, Source, IP
      var cells = [
        v.device_type || 'unknown',
        v.browser || 'unknown',
        v.os || 'unknown',
        v.utm_source || 'direct',
        v.visitor_ip || '',
      ];
      cells.forEach(function(val) {
        var td = document.createElement('td');
        td.style.fontSize = '12px';
        td.textContent = val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('Tracking visits error:', e);
  }
}

async function saveManualMetrics() {
  var btn = document.getElementById('saveMetricsBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  try {
    var payload = {
      impressions: parseInt(document.getElementById('mm-impressions').value) || 0,
      clicks: parseInt(document.getElementById('mm-clicks').value) || 0,
      spend: parseFloat(document.getElementById('mm-spend').value) || 0,
      leads_captured: parseInt(document.getElementById('mm-leads').value) || 0,
    };
    var res = await fetch('/api/ad-campaigns/' + campaignId + '/manual-metrics', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (res.ok) {
      btn.textContent = 'Saved!';
      loadCampaign();
      loadChart();
      setTimeout(function() { btn.textContent = 'Save Metrics'; btn.disabled = false; }, 2000);
    } else {
      var err = await res.json();
      alert(err.error || 'Failed to save');
      btn.textContent = 'Save Metrics';
      btn.disabled = false;
    }
  } catch (e) {
    alert('Error: ' + e.message);
    btn.textContent = 'Save Metrics';
    btn.disabled = false;
  }
}

function copyTrackingLink() {
  var url = document.getElementById('ext-tracking-url').textContent;
  navigator.clipboard.writeText(url).then(function() {
    var btn = document.getElementById('copyTrackBtn');
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
  });
}

loadCampaign();
loadChart();
loadLeads();
</script>

<%- include('partials/footer') %>
